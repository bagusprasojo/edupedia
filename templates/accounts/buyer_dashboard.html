{% extends 'base.html' %}
{% load account_custom_tags %}
{% load static %}

{% block content_top %}
<div class="container py-5">

  <!-- Hero Section -->
  <div class="bg-primary text-white rounded-4 p-4 p-md-5 mb-4 shadow-sm">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <div>
        <p class="text-uppercase small mb-2">Dashboard Buyer</p>
        <h2 class="mb-1">Halo, {{ user.first_name|default:user.username }}!</h2>
        <p class="mb-0">Akses semua pembelianmu, lanjutkan belajar, dan nikmati promo terbaru di satu tempat.</p>
      </div>
      <div class="text-md-end w-100" style="max-width:220px;">
        <a href="{% url 'keranjang' %}" class="btn btn-light text-primary fw-semibold mb-2 w-100">Lanjutkan Belanja</a>
        <a href="{% url 'logout' %}" class="btn btn-outline-light w-100">Logout</a>
      </div>
    </div>
  </div>

  <!-- Snapshot Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1">Order Aktif</p>
          <h4 class="mb-2">{{ orders|length }}</h4>
          <small class="text-success">Periksa status pembayaran</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1">Produk Dibeli</p>
          <h4 class="mb-2">{{ total_produk|default:0 }}</h4>
          <small class="text-primary">Semua paket edukasi aktif</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1">Progress Terakhir</p>
          <h4 class="mb-2">
            {% if orders and orders.0.items.all %}
              {{ orders.0.items.all.0.progress|default:"0%" }}
            {% else %}
              0%
            {% endif %}
          </h4>
          <small class="text-muted">Update otomatis dari kelas terbaru</small>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <p class="text-muted mb-1">Voucher / Poin</p>
          <h4 class="mb-2">{{ user.profile.points|default:0 }}</h4>
          <small class="text-warning">Tukarkan untuk diskon tambahan</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Orders and Learning Access -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
            <div>
              <h5 class="mb-1">Produk &amp; Kelas Kamu</h5>
              <small class="text-muted">Filter untuk melihat status pembelian</small>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-primary active">Aktif</button>
              <button type="button" class="btn btn-outline-primary">Selesai</button>
              <button type="button" class="btn btn-outline-primary">Diarsip</button>
            </div>
          </div>

          {% if orders %}
            <div class="list-group list-group-flush">
              {% for order in orders %}
                {% for item in order.items.all %}
                  <div class="list-group-item px-0 py-3">
                    <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
                      <div>
                        <h6 class="mb-1">{{ item.produk.nama }}</h6>
                        <p class="mb-1 small text-muted">
                          Dibeli {{ order.tanggal|date:"d M Y" }} · Status:
                          <span class="text-capitalize"></span>
                        </p>
                        <div class="d-flex gap-2 flex-wrap">
                          <a href="{% url 'paket_per_produk' item.produk.uuid %}" class="btn btn-sm btn-primary">Lanjutkan Belajar</a>
                          <a href="#" class="btn btn-sm btn-outline-secondary">Invoice</a>
                          <a href="#" class="btn btn-sm btn-outline-secondary">Sertifikat</a>
                        </div>
                      </div>
                      <div class="text-md-end">
                        <p class="small text-muted mb-2">Terakhir diakses:
                          {{ item.last_access|default:"Belum ada aktivitas" }}
                        </p>
                        <a href="#" class="link-primary small">Lihat detail order &rsaquo;</a>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5">
              <p class="text-muted mb-3">Kamu belum membeli produk apapun.</p>
              <a href="{% url 'keranjang' %}" class="btn btn-primary">Jelajahi Produk Populer</a>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Activity Feed -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Aktivitas Terbaru</h5>
            <a href="#" class="small text-primary">Kelola notifikasi</a>
          </div>
          <ul class="list-unstyled mb-0">
            {% if orders %}
              {% for order in orders|slice:":3" %}
                <li class="mb-3 pb-3 border-bottom">
                  <div class="d-flex justify-content-between">
                    <div>
                      <strong>Pembayaran order #{{ order.id }}</strong>
                      <p class="mb-0 small text-muted">Status: </p>
                    </div>
                    <small class="text-muted">{{ order.tanggal|date:"d M Y" }}</small>
                  </div>
                </li>
              {% endfor %}
            {% else %}
              <li class="text-muted">Belum ada aktivitas. Mulai dengan membeli kelas pertama kamu.</li>
            {% endif %}
          </ul>
        </div>
      </div>

      <!-- Recommendations -->
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-1">Rekomendasi Untukmu</h5>
              <small class="text-muted">Dipersonalisasi berdasarkan kelas favoritmu</small>
            </div>
            <a href="#" class="small text-primary">Lihat semua</a>
          </div>
          <div class="row g-3">
            {% for i in "123" %}
              <div class="col-md-4">
                <div class="border rounded-3 p-3 h-100">
                  <p class="text-uppercase small text-muted mb-1">Trending</p>
                  <h6 class="mb-2">Kelas Populer {{ forloop.counter }}</h6>
                  <p class="small text-muted mb-3">Perdalam skill terbaru dengan mentor expert.</p>
                  <a href="#" class="small fw-semibold text-primary">Lihat detail &rsaquo;</a>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h6 class="text-uppercase small text-muted">Membership</h6>
          <h4 class="mb-1">{{ user.profile.membership_level|default:"Member" }}</h4>
          <p class="small text-muted mb-3">Terus belanja untuk unlock reward berikutnya.</p>
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ user.profile.membership_progress|default:35 }}%;"></div>
          </div>
          <ul class="list-unstyled small mb-3">
            <li>✓ Cashback poin ekstra</li>
            <li>✓ Akses webinar premium</li>
            <li>✓ Prioritas support</li>
          </ul>
          <a href="#" class="btn btn-sm btn-primary w-100">Lihat Benefit</a>
        </div>
      </div>

      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h6 class="text-uppercase small text-muted mb-3">Dukungan &amp; Keamanan</h6>
          <div class="mb-3">
            <p class="mb-1 fw-semibold">Butuh bantuan?</p>
            <p class="small text-muted mb-2">Tim CS siap membantu 09.00 - 21.00 WIB.</p>
            <a href="#" class="btn btn-outline-primary btn-sm w-100 mb-2">Hubungi CS</a>
            <a href="#" class="btn btn-outline-secondary btn-sm w-100">FAQ &amp; Panduan</a>
          </div>
          <hr>
          <div>
            <p class="mb-1 fw-semibold">Keamanan Akun</p>
            <p class="small text-muted mb-2">Aktifkan verifikasi dua langkah supaya akun makin aman.</p>
            <a href="#" class="small text-primary">Atur keamanan &rsaquo;</a>
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h6 class="text-uppercase small text-muted mb-3">Jadwal Belajar</h6>
          <p class="mb-2 fw-semibold">
            {% if orders and orders.0.items.all %}
              Sesi berikutnya: {{ orders.0.items.all.0.jadwal_mulai|default:"Belum dijadwalkan" }}
            {% else %}
              Belum ada jadwal
            {% endif %}
          </p>
          <p class="small text-muted mb-3">Sinkronkan ke kalender agar tidak ketinggalan sesi live.</p>
          <a href="#" class="btn btn-sm btn-outline-primary w-100">Sinkron ke Kalender</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
