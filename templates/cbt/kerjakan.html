{% extends 'base.html' %}
{% load static %}
{% load cbt_custom_tags %}

{% block content_top %}
<div class="container py-5">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <p class="text-muted mb-1">Paket: {{ paket.nama }}</p>
              <h5 class="mb-0">Soal {{ current_number }} dari {{ total_soal }}</h5>
            </div>
            <span class="badge text-bg-light">Auto-save aktif</span>
          </div>

          <form method="post"
                id="question-form"
                data-ajax-url="{{ ajax_save_url }}"
                data-soal-id="{{ current_soal.id }}">
            {% csrf_token %}
            <input type="hidden" name="current_number" value="{{ current_number }}">
            <input type="hidden" name="soal_id" value="{{ current_soal.id }}">

            <p class="mb-4">{{ current_soal.teks|linebreaks }}</p>

            <div class="ms-1">
              <div class="form-check mb-2">
                <input class="form-check-input answer-option"
                       type="radio"
                       name="selected_answer"
                       value="A"
                       data-option="A"
                       {% if selected_answer == 'A' %}checked{% endif %}>
                <label class="form-check-label">
                  A. {{ current_soal.opsi_a }}
                </label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input answer-option"
                       type="radio"
                       name="selected_answer"
                       value="B"
                       data-option="B"
                       {% if selected_answer == 'B' %}checked{% endif %}>
                <label class="form-check-label">
                  B. {{ current_soal.opsi_b }}
                </label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input answer-option"
                       type="radio"
                       name="selected_answer"
                       value="C"
                       data-option="C"
                       {% if selected_answer == 'C' %}checked{% endif %}>
                <label class="form-check-label">
                  C. {{ current_soal.opsi_c }}
                </label>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input answer-option"
                       type="radio"
                       name="selected_answer"
                       value="D"
                       data-option="D"
                       {% if selected_answer == 'D' %}checked{% endif %}>
                <label class="form-check-label">
                  D. {{ current_soal.opsi_d }}
                </label>
              </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <button type="submit"
                      name="action"
                      value="save_prev"
                      class="btn btn-outline-secondary"
                      {% if not has_prev %}disabled{% endif %}>
                ‹ Soal Sebelumnya
              </button>
              <button type="submit"
                      name="action"
                      value="save_next"
                      class="btn btn-primary"
                      {% if not has_next %}disabled{% endif %}>
                Simpan & Berikutnya ›
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h6 class="mb-3">Progress Ujian</h6>
          <div class="progress" style="height: 10px;">
            <div class="progress-bar"
                 id="progress-bar"
                 role="progressbar"
                 style="width: {{ progress_percent }}%;"
                 aria-valuenow="{{ progress_percent }}"
                 aria-valuemin="0"
                 aria-valuemax="100"></div>
          </div>
          <p class="mt-3 mb-1">
            Sudah dijawab:
            <strong id="answered-count">{{ answered_count }}</strong> / {{ total_soal }}
          </p>
          <p class="text-muted mb-0">
            Belum dijawab: <span id="unanswered-count">{{ unanswered_count }}</span>
          </p>
        </div>
      </div>

      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Navigasi Soal</h6>
            <small class="text-muted">Hijau = terjawab</small>
          </div>
          <div class="question-palette d-flex flex-wrap gap-2">
            {% for item in question_palette %}
              <a href="{{ item.url }}"
                 class="btn btn-sm palette-item {% if item.status == 'answered' %}btn-success{% else %}btn-outline-secondary{% endif %} {% if item.number == current_number %}active-question{% endif %}"
                 data-soal-id="{{ item.soal_id }}">
                {{ item.number }}
              </a>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="mb-3">Selesai Ujian?</h6>
          <p class="text-muted small">Pastikan semua jawaban sudah benar sebelum mengumpulkan.</p>
          <button type="submit"
                  form="question-form"
                  name="action"
                  value="final_submit"
                  class="btn btn-success w-100">
            Kumpulkan Jawaban
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .question-palette .palette-item {
    min-width: 42px;
    text-align: center;
  }
  .question-palette .palette-item.active-question {
    box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.4);
  }
</style>

<script>
  (function() {
    const form = document.getElementById('question-form');
    if (!form) {
      return;
    }

    const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
    const ajaxUrl = form.dataset.ajaxUrl;
    const progressBar = document.getElementById('progress-bar');
    const answeredEl = document.getElementById('answered-count');
    const unansweredEl = document.getElementById('unanswered-count');

    function updatePalette(soalId, answered) {
      document.querySelectorAll('.palette-item').forEach(function(btn) {
        if (btn.dataset.soalId === soalId.toString()) {
          btn.classList.toggle('btn-outline-secondary', !answered);
          btn.classList.toggle('btn-success', answered);
        }
      });
    }

    form.querySelectorAll('.answer-option').forEach(function(input) {
      input.addEventListener('change', function() {
        if (!ajaxUrl) {
          return;
        }

        const payload = {
          soal_id: form.dataset.soalId,
          jawaban: this.value
        };

        fetch(ajaxUrl, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(payload)
        })
        .then(function(res) {
          if (!res.ok) {
            throw new Error('Gagal menyimpan jawaban');
          }
          return res.json();
        })
        .then(function(data) {
          if (answeredEl) {
            answeredEl.textContent = data.answered;
          }
          if (unansweredEl) {
            unansweredEl.textContent = data.unanswered;
          }
          if (progressBar) {
            progressBar.style.width = data.progress_percent + '%';
            progressBar.setAttribute('aria-valuenow', data.progress_percent);
          }
          updatePalette(data.soal_id, true);
        })
        .catch(function(err) {
          console.error(err);
        });
      });
    });
  })();
</script>
{% endblock %}
